name: test CI

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test
  
  build:
    runs-on: ubuntu-latest
    needs: test
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '14'
      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm start
      
      - name: send mail
        run: |
          curl -X POST ${{ secrets.KEY_BOT }} \
          -H "Content-Type: application/json" \
          -d '{
              "embeds": [
                {
                  "title": "üöÄ Build Success!",
                  "description": "Your build has completed successfully! üéâ",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "Build Status",
                      "value": "‚úÖ SUCCESS",
                      "inline": true
                    },
                    {
                      "name": "Time Taken",
                      "value": "‚è±Ô∏è 5 minutes",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "CI Pipeline - Powered by GitHub Actions"
                  },
                  "thumbnail": {
                    "url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  }
                }
              ]
            }'
    